<!DOCTYPE html>
<html>
	<head>
		<title>File reformatter</title>
	</head>
	<body>
		<div id="inputs">
			Inputs: <input type="file" id="inputfiles" multiple /> <br/>
			<select id="reformatter">
				<!-- options will be generated via javascript -->
			</select>
			<div id="arguments">
				<!-- arguments will be generated via javascript -->
			</div>
			<button id="submit" disabled="disabled">Reformat</button>
		</div>
		<script
			src="https://code.jquery.com/jquery-3.2.1.min.js"
			integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			crossorigin="anonymous"></script>
		<script type="text/javascript">
			if (!window.Worker) {
				alert('This website can not be used, because your browser does not support the Worker api!');
			} else {
var reformatters = [
	new Reformatter('Replacer', ['replace', 'with']),
	new Reformatter('Hoffelner-Cashdesk', [])
];
reformatters.forEach(function(r) {
	reformatters[r.name] = r;
});
var selectedReformatter = null;

$(document).ready(function() {
	$('#reformatter').html(
		'<option value="">-----</option>' + 
		reformatters
			.map(function(r) { 
				return '<option value="' + r.name + '">' + r.name + '</option>';
			})
			.join("\n")
	).change(function(e) {
		var selectedReformatterName = $(e.target).val();
		selectedReformatter = selectedReformatterName === '' ? null : reformatters[selectedReformatterName];
		$('#submit').attr('disabled', selectedReformatter === null);
		if (selectedReformatter) {
			$('#arguments').html(
				selectedReformatter.argumentNames.map(function(a, i) {
					return a + ': <input type="text" />';
				})
			);
		} else {
			$('#arguments').html('');
		}
	});
	
	$('#submit').click(function() {
		var inputFiles = $('#inputfiles')[0].files;
		var fileContents = [];
		var finished = [];
		for (var i = 0; i < inputFiles.length; i++) {
			(function(index) {
				finished[index] = false;
				var reader = new FileReader();
				reader.onload = function(e) {
					fileContents[index] = {
						'name': inputFiles[index].name,
						'content': reader.result
					};
					finished[index] = true;
					if (finished.indexOf(false) == -1) { // all files read
						var args = [fileContents];
						$('#arguments input').each(function(i, e) {
							args.push($(e).val());
						});
						console.log(fileContents, args);
						selectedReformatter.reformat(args);
					}
				}
				reader.readAsText(inputFiles[index]);
			})(i);
		};
	});
});

function Reformatter(name, argumentNames) {
	this.name = name;
	this.argumentNames = argumentNames;
	this.worker = null;
}
Reformatter.prototype.reformat = function(args) {
	if (this.worker === null) {
		this.worker = new Worker('reformatters/' + this.name + '.js');
		this.worker.onmessage = function(e) {
			console.log('refactored: ', e.data);
			$('#result').val(e.data);
			e.data.forEach(function(result, i) {
				downloadStringAsFile(result.name, result.content);
			});
		};
	}
	this.worker.postMessage(args);
}

function downloadStringAsFile(filename, contents) {
	$a = $('<a>', {
		'href': 'data:text/plain;charset=utf-8,' + encodeURIComponent(contents),
		'download': filename
		//'style': 'display: none'
	});
	$('body').append($a);
	var evObj = document.createEvent('MouseEvents');
	evObj.initMouseEvent('click', true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
	$a[0].dispatchEvent(evObj);
	$a.remove();
}
			}
		</script>
	</body>
</html>
